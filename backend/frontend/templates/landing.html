{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow Dashboard</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Welcome to TeamFlow ðŸš€</h1>
            <button id="logoutBtn" class="btn-danger">Logout</button>
        </header>

        <!-- Workspace Creation Form -->
        <div class="form-container">
            <h3>Create New Workspace</h3>
            <form id="createWorkspaceForm">
                <input type="text" id="workspaceName" placeholder="Workspace Name" required>
                <textarea id="workspaceDescription" placeholder="Description (optional)"></textarea>
                <button type="submit" class="btn-primary">Create Workspace</button>
            </form>
        </div>

        <!-- User's Workspaces -->
        <div class="workspace-section">
            <h2>Your Workspaces</h2>
            <div id="workspacesList" class="loading">
                Loading your workspaces...
            </div>
        </div>
    </div>

    <!-- Supabase client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://emwyjdkjbrepvqsdzzfx.supabase.co';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const API_BASE_URL = 'http://127.0.0.1:8080/api';

        async function makeAuthenticatedRequest(url, options = {}) {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '/login/';
                return null;
            }
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${session.access_token}`,
                    'Content-Type': 'application/json'
                }
            };
            const response = await fetch(url, { ...defaultOptions, ...options });
            if (!response.ok) throw new Error(`Error ${response.status}`);
            return await response.json();
        }

        async function loadWorkspaces() {
            try {
                const workspaces = await makeAuthenticatedRequest(`${API_BASE_URL}/workspaces/`);
                const container = document.getElementById('workspacesList');
                if (!workspaces || workspaces.length === 0) {
                    container.innerHTML = '<p>No workspaces yet. Create one above!</p>';
                    return;
                }
                container.innerHTML = workspaces.map(ws => `
                    <div class="workspace-card">
                        <h4>${ws.name}</h4>
                        <p><strong>Owner:</strong> ${ws.owner_email}</p>
                        <p><strong>Members:</strong> ${ws.member_count}</p>
                        <p><strong>Created:</strong> ${new Date(ws.created_at).toLocaleDateString()}</p>
                        <button onclick="window.location.href='/workspace/?id=${ws.id}'" class="btn-primary">
                            View Details
                        </button>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('workspacesList').innerHTML = '<p>Error loading workspaces.</p>';
            }
        }

        document.getElementById('createWorkspaceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('workspaceName').value;
            const description = document.getElementById('workspaceDescription').value;
            try {
                await makeAuthenticatedRequest(`${API_BASE_URL}/workspaces/`, {
                    method: 'POST',
                    body: JSON.stringify({ name, description })
                });
                loadWorkspaces();
                e.target.reset();
            } catch (err) {
                alert('Error creating workspace: ' + err.message);
            }
        });

        document.getElementById('logoutBtn').onclick = async () => {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        };

        document.addEventListener('DOMContentLoaded', loadWorkspaces);
    </script>
</body>
</html>

