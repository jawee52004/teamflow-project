<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workspace Details</title>
  <link rel="stylesheet" href="workspace.css">
</head>
<body>
  <div class="container">

    <!-- Back button -->
    <div style="margin-bottom: 20px;">
      <a href="landing.html" class="btn-back">‚Üê Back to Workspaces</a>
    </div>

    <h2 id="workspaceName"></h2>
    <p id="workspaceDesc"></p>
    <p><strong>Owner:</strong> <span id="workspaceOwner"></span></p>
    <p><strong>Created:</strong> <span id="workspaceCreated"></span></p>

    <h3>Members</h3>
    <ul id="membersList"></ul>

    <h3>Tasks</h3>
    <ul id="tasksList"></ul>

    <h4>Add Task</h4>
    <form id="taskForm">
      <input type="text" id="taskTitle" placeholder="Task Title" required>
      <textarea id="taskDesc" placeholder="Task Description"></textarea>
      <select id="taskStatus">
        <option value="TODO">To-Do</option>
        <option value="IN_PROGRESS">In Progress</option>
        <option value="DONE">Done</option>
      </select>
      <button type="submit">Add Task</button>
    </form>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const workspaceId = params.get("id");
    const token = localStorage.getItem("authToken");

    async function makeAuthenticatedRequest(url, options = {}) {
      if (!options.headers) options.headers = {};
      options.headers["Authorization"] = "Bearer " + token;
      return fetch(url, options);
    }

    async function loadWorkspaceDetails() {
      const res = await makeAuthenticatedRequest(
        `http://127.0.0.1:8080/api/workspaces/${workspaceId}/`
      );

      if (!res.ok) {
        console.error("Failed to load workspace:", res.status);
        return;
      }

      const ws = await res.json();

      document.getElementById("workspaceName").textContent = ws.name;
      document.getElementById("workspaceDesc").textContent = ws.description;
      document.getElementById("workspaceOwner").textContent = ws.owner?.email || "Unknown";
      document.getElementById("workspaceCreated").textContent = new Date(ws.created_at).toLocaleString();

      const membersList = document.getElementById("membersList");
      membersList.innerHTML = "";
      (ws.members || []).forEach(m => {
        const li = document.createElement("li");
        li.textContent = `${m.user?.email || "Unknown"} (${m.role})`;
        membersList.appendChild(li);
      });

      const tasksList = document.getElementById("tasksList");
      tasksList.innerHTML = "";
      (ws.tasks || []).forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${t.title}</strong>
          <span class="task-status status-${t.status}">${t.status}</span><br>
          ${t.description || ""}
        `;
        tasksList.appendChild(li);
      });
    }

    document.getElementById("taskForm").addEventListener("submit", async e => {
      e.preventDefault();
      const title = document.getElementById("taskTitle").value;
      const description = document.getElementById("taskDesc").value;
      const status = document.getElementById("taskStatus").value;

      const res = await makeAuthenticatedRequest(
        `http://127.0.0.1:8080/api/workspaces/${workspaceId}/tasks/`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, description, status })
        }
      );

      if (!res.ok) {
        alert("Failed to add task. Error: " + res.status);
        return;
      }

      document.getElementById("taskForm").reset();
      loadWorkspaceDetails();
    });

    loadWorkspaceDetails();
  </script>
</body>
</html>
