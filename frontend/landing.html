<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Welcome to TeamFlow! ðŸš€</h1>
            <p>You are now logged in.</p>
            <button id="logoutBtn" class="btn-danger">Logout</button>
        </header>

        <!-- Workspace Creation Form -->
        <div class="form-container">
            <h3>Create New Workspace</h3>
            <form id="createWorkspaceForm">
                <input type="text" id="workspaceName" placeholder="Workspace Name" required>
                <textarea id="workspaceDescription" placeholder="Description (optional)"></textarea>
                <button type="submit" class="btn-primary">Create Workspace</button>
            </form>
        </div>

        <!-- User's Workspaces -->
        <div class="workspace-section">
            <h2>Your Workspaces</h2>
            <div id="workspacesList" class="loading">
                Loading your workspaces...
            </div>
        </div>

        <!-- Workspace Details Modal -->
        <div id="workspaceModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal()">Ã—</button>
                <h3 id="modalTitle">Workspace Details</h3>
                <div id="modalContent"></div>
                <button onclick="closeModal()" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Load Supabase library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://emwyjdkjbrepvqsdzzfx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVtd3lqZGtqYnJlcHZxc2R6emZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NzQwODEsImV4cCI6MjA3NDM1MDA4MX0.xqmZxYzIoiA1ZMthFCJnh5NsIB-9AmtxzmIs5mg-sVs';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Backend API base URL
        const API_BASE_URL = 'http://localhost:8000/api';

        // Function to make authenticated API calls
        async function makeAuthenticatedRequest(url, options = {}) {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                alert('Please login again');
                window.location.href = 'login.html';
                return null;
            }
            
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${session.access_token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            const mergedOptions = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(url, mergedOptions);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Load user's workspaces
        async function loadWorkspaces() {
            try {
                const workspaces = await makeAuthenticatedRequest(`${API_BASE_URL}/workspaces/`);
                displayWorkspaces(workspaces);
            } catch (error) {
                document.getElementById('workspacesList').innerHTML = '<p class="message error">Error loading workspaces. Please try again.</p>';
            }
        }

        // Display workspaces in the UI
        function displayWorkspaces(workspaces) {
            const workspacesList = document.getElementById('workspacesList');
            
            if (!workspaces || workspaces.length === 0) {
                workspacesList.innerHTML = '<p class="message">No workspaces found. Create your first workspace above!</p>';
                return;
            }

            workspacesList.innerHTML = workspaces.map(workspace => `
                <div class="workspace-card">
                    <h4>${workspace.name}</h4>
                    <p>${workspace.description || 'No description'}</p>
                    <p><strong>Owner:</strong> ${workspace.owner_username}</p>
                    <p><strong>Members:</strong> ${workspace.member_count}</p>
                    <p><strong>Created:</strong> ${new Date(workspace.created_at).toLocaleDateString()}</p>
                    
                    <button onclick="viewWorkspace(${workspace.id})" class="btn-primary">View Details</button>
                    <button onclick="createProject(${workspace.id})" class="btn-primary">Add Project</button>
                    <button onclick="deleteWorkspace(${workspace.id})" class="btn-danger">Delete</button>
                    
                    <div id="projects-${workspace.id}" class="project-list"></div>
                </div>
            `).join('');

            // Load projects for each workspace
            workspaces.forEach(workspace => loadProjects(workspace.id));
        }

        // Load projects for a specific workspace
        async function loadProjects(workspaceId) {
            try {
                const projects = await makeAuthenticatedRequest(`${API_BASE_URL}/workspaces/${workspaceId}/projects/`);
                displayProjects(workspaceId, projects);
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        // Display projects for a workspace
        function displayProjects(workspaceId, projects) {
            const projectsContainer = document.getElementById(`projects-${workspaceId}`);
            
            if (!projects || projects.length === 0) {
                projectsContainer.innerHTML = '<p>No projects in this workspace.</p>';
                return;
            }

            projectsContainer.innerHTML = `
                <h5>Projects:</h5>
                <ul>
                    ${projects.map(project => `
                        <li>
                            <strong>${project.name}</strong> - ${project.description || 'No description'}
                            <br><small>Created by: ${project.created_by_username}</small>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // Create new workspace
        document.getElementById('createWorkspaceForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const name = document.getElementById('workspaceName').value;
            const description = document.getElementById('workspaceDescription').value;

            try {
                await makeAuthenticatedRequest(`${API_BASE_URL}/workspaces/`, {
                    method: 'POST',
                    body: JSON.stringify({ name, description })
                });
                
                alert('Workspace created successfully!');
                document.getElementById('createWorkspaceForm').reset();
                loadWorkspaces(); // Reload the list
            } catch (error) {
                alert('Error creating workspace: ' + error.message);
            }
        });

        // Create new project in a workspace
        async function createProject(workspaceId) {
            const projectName = prompt('Enter project name:');
            if (!projectName) return;

            const projectDescription = prompt('Enter project description (optional):') || '';

            try {
                await makeAuthenticatedRequest(`${API_BASE_URL}/workspaces/${workspaceId}/projects/`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        name: projectName, 
                        description: projectDescription 
                    })
                });
                
                alert('Project created successfully!');
                loadProjects(workspaceId); // Reload projects for this workspace
            } catch (error) {
                alert('Error creating project: ' + error.message);
            }
        }

        // View workspace details
        async function viewWorkspace(workspaceId) {
            try {
                const workspace = await makeAuthenticatedRequest(`${API_BASE_URL}/workspaces/${workspaceId}/`);
                openModal('Workspace Details', `
                    <h4>${workspace.name}</h4>
                    <p><strong>Description:</strong> ${workspace.description || 'No description'}</p>
                    <p><strong>Owner:</strong> ${workspace.owner_username}</p>
                    <p><strong>Members:</strong> ${workspace.member_count}</p>
                    <p><strong>Created:</strong> ${new Date(workspace.created_at).toLocaleDateString()}</p>
                    <p><strong>Last Updated:</strong> ${new Date(workspace.updated_at).toLocaleDateString()}</p>
                `);
            } catch (error) {
                alert('Error loading workspace details: ' + error.message);
            }
        }

        // Delete workspace
        async function deleteWorkspace(workspaceId) {
            if (!confirm('Are you sure you want to delete this workspace? This action cannot be undone.')) {
                return;
            }

            try {
                await makeAuthenticatedRequest(`${API_BASE_URL}/workspaces/${workspaceId}/`, {
                    method: 'DELETE'
                });
                
                alert('Workspace deleted successfully!');
                loadWorkspaces(); // Reload the list
            } catch (error) {
                alert('Error deleting workspace: ' + error.message);
            }
        }

        // Modal functions
        function openModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('workspaceModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('workspaceModal').style.display = 'none';
        }

        // Logout function
        document.getElementById('logoutBtn').onclick = async function() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('workspaceModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadWorkspaces();
        });
    </script>
</body>
</html>